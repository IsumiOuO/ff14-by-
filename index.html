<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14 å¿«é€Ÿéµé¸å–®ç³»çµ± byå¤§é‹é‹ (æœ€çµ‚ä¿®æ­£ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background-color: #0f172a; color: #cbd5e1; }
        
        /* é¢æ¿æ¨£å¼ */
        .panel { background-color: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .panel-title { font-size: 1.1rem; font-weight: 700; color: #60a5fa; border-bottom: 1px solid #334155; padding-bottom: 0.5rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; }
        
        /* è¼¸å…¥å…ƒä»¶ */
        label { display: block; margin-bottom: 0.3rem; font-size: 0.85rem; color: #94a3b8; }
        select, input[type="number"] { background-color: #0f172a; border: 1px solid #475569; color: white; padding: 0.5rem; border-radius: 0.25rem; width: 100%; transition: all 0.2s; font-size: 0.9rem; }
        select:focus, input:focus { border-color: #3b82f6; outline: none; ring: 2px solid rgba(59, 130, 246, 0.5); }
        
        /* Checkbox */
        .cb-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 0.5rem; }
        .cb-item { background: #334155; padding: 0.5rem; border-radius: 4px; text-align: center; cursor: pointer; font-size: 0.8rem; border: 1px solid transparent; transition: 0.2s; }
        .cb-item:hover { background: #475569; }
        .cb-item.active { background: #2563eb; color: white; border-color: #60a5fa; font-weight: bold; }

        /* è¨­å®šå¡ç‰‡ */
        .spoke-card { background: #0f172a; border: 1px solid #334155; border-radius: 6px; padding: 12px; margin-bottom: 12px; position: relative; }
        .spoke-label { position: absolute; top: -10px; left: 10px; background: #1e293b; padding: 0 8px; font-size: 0.8rem; color: #60a5fa; font-weight: bold; border: 1px solid #334155; border-radius: 4px; }

        /* è¦–è¦ºåŒ–æ ¼å­ */
        .bar-container { margin-bottom: 1rem; }
        .bar-label { font-size: 0.75rem; color: #fbbf24; margin-bottom: 2px; display: flex; justify-content: space-between; }
        .slots-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 2px; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 4px; border: 1px solid #475569; }
        
        .slot { 
            aspect-ratio: 1; background: #1e293b; border: 1px solid #334155; border-radius: 2px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 0.6rem; position: relative; color: #64748b; cursor: default;
        }
        
        .slot.trigger { background: #059669; color: white; border-color: #34d399; font-weight: bold; cursor: pointer; }
        .slot.close { background: #dc2626; color: white; border-color: #f87171; font-weight: bold; cursor: pointer; }
        .slot.content { background: #2563eb; border-color: #60a5fa; color: white; opacity: 0.8; }
        .slot.reset { background: #475569; border-color: #64748b; color: #94a3b8; border-style: dashed; }
        
        /* å·¨é›†æ–‡å­—æ¡† */
        textarea.macro { display: block; background: #020617; color: #4ade80; font-family: Consolas, monospace; width: 100%; height: 130px; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #334155; resize: none; font-size: 0.85rem; line-height: 1.4; margin-bottom: 5px; }
        .btn-copy { background: #3b82f6; color: white; width: 100%; padding: 0.6rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.9rem; transition: 0.2s; cursor: pointer; border: none; }
        .btn-copy:hover { background: #2563eb; }
        .btn-copy:active { transform: translateY(1px); }

        /* RWD */
        .layout-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; align-items: start; }
        @media (min-width: 1280px) {
            .layout-grid { grid-template-columns: 400px 1fr 350px; }
        }
    </style>
</head>
<body class="p-4 md:p-6 min-h-screen">

    <header class="text-center mb-8">
        <h1 class="text-2xl md:text-3xl font-bold text-blue-400 mb-2">FF14 å¿«é€Ÿéµé¸å–®ç³»çµ± <span class="text-lg font-normal text-gray-400 ml-2">byå¤§é‹é‹</span></h1>
        <p class="text-sm text-gray-400">é‚è¼¯ä¿®æ­£ï¼šä¿®å¾©é è¦½ç¨‹å¼ç¢¼æ¶ˆå¤±èˆ‡è¤‡è£½éŒ¯èª¤çš„å•é¡Œ</p>
    </header>

    <div class="layout-grid max-w-[1920px] mx-auto">
        
        <div class="space-y-6">
            
            <div class="panel border-l-4 border-blue-500">
                <div class="panel-title">1. å®šç¾©å…±ç”¨æ¬„ä½ (Targets)</div>
                <p class="text-xs text-gray-400 mb-4">å‹¾é¸å¹¾å€‹ï¼Œä¸‹æ–¹å°±æœƒè‡ªå‹•ç”¢ç”Ÿå¹¾è¡Œè¨­å®šã€‚</p>
                <div class="cb-grid" id="shared-cb-container"></div>
            </div>

            <div class="panel border-l-4 border-orange-500">
                <div class="panel-title">2. å€‰åº«èˆ‡ä¸­æ¨ (Hub)</div>
                <div class="mb-4">
                    <label>å€‰åº«è·æ¥­</label>
                    <select id="storageJob" onchange="updateAll()">
                        <optgroup label="èƒ½å·¥å·§åŒ ">
                            <option value="LTW" selected>è£½é©åŒ  (LTW)</option>
                            <option value="CRP">åˆ»æœ¨åŒ  (CRP)</option>
                            <option value="BSM">é›éµåŒ  (BSM)</option>
                            <option value="ARM">é‘„ç”²åŒ  (ARM)</option>
                            <option value="GSM">é›•é‡‘åŒ  (GSM)</option>
                            <option value="WVR">è£è¡£åŒ  (WVR)</option>
                            <option value="ALC">éŠé‡‘è¡“å£« (ALC)</option>
                            <option value="CUL">çƒ¹èª¿å¸« (CUL)</option>
                        </optgroup>
                        <optgroup label="å¤§åœ°ä½¿è€…">
                            <option value="MIN">æ¡ç¤¦å·¥ (MIN)</option>
                            <option value="BTN">åœ’è—å·¥ (BTN)</option>
                            <option value="FSH">æ•é­šäºº (FSH)</option>
                        </optgroup>
                        <optgroup label="åŸºç¤/æˆ°é¬¥è·æ¥­">
                             <option value="GLA">åŠè¡“å¸« (GLA)</option>
                             <option value="ARC">å¼“ç®­æ‰‹ (ARC)</option>
                             <option value="MRD">æ–§è¡“å¸« (MRD)</option>
                        </optgroup>
                    </select>
                </div>

                <div class="bg-slate-800 p-3 rounded mb-2 border border-slate-700">
                    <label class="text-orange-300 font-bold mb-2">ä¸­æ¨ä½ç½® (Hub)</label>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label>å€‰åº«æ¬„ä½ (å­˜æ”¾é–‹å•Ÿéˆ•)</label>
                            <select id="hubSource" onchange="onHubChange()"></select>
                        </div>
                        <div class="w-20">
                            <label>æŒ‰éˆ•æ ¼æ•¸</label>
                            <input type="number" id="triggerSlot" value="1" min="1" max="12" onchange="updateAll()">
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel border-l-4 border-green-500">
                <div class="panel-title">3. é¸å–®å…§å®¹å°æ‡‰ (Spokes)</div>
                <p class="text-xs text-gray-400 mb-4">è¨­å®šæ¯ä¸€æ’å…±ç”¨æ¬„ä½çš„é–‹å•Ÿä¾†æºèˆ‡é‚„åŸç›®æ¨™ã€‚</p>
                
                <div id="dynamic-rows-container"></div>

                <div class="flex items-center gap-3 bg-slate-800 p-2 rounded mt-4">
                    <input type="checkbox" id="autoClose" class="w-4 h-4" checked onchange="updateAll()">
                    <label for="autoClose" class="!mb-0 cursor-pointer">å•Ÿç”¨è‡ªå‹•é—œé–‰</label>
                    <input type="number" id="waitSec" value="8" class="w-16 !p-1 text-center" onchange="updateAll()">
                    <span class="text-xs">ç§’</span>
                </div>
            </div>

        </div>

        <div class="space-y-6">
            <div class="panel h-full">
                <div class="panel-title">
                    <span>è¦–è¦ºåŒ–æª¢è¦–</span>
                    <span class="text-xs font-normal text-gray-400">Warehouse & Live View</span>
                </div>

                <div class="mb-8">
                    <h3 class="text-sm font-bold text-orange-400 mb-2">ğŸ­ å€‰åº«ç‹€æ…‹ (Storage)</h3>
                    <p class="text-xs text-gray-500 mb-4">æ³¨æ„ï¼šåªæœ‰ç¬¬ä¸€åˆ—çš„ä¾†æºæ¬„ä½éœ€è¦è¨­å®šç´…è‰²é—œé–‰æŒ‰éˆ•ã€‚</p>
                    <div id="warehouse-view"></div>
                </div>

                <div class="flex justify-center mb-8 text-2xl text-gray-600 animate-pulse">â¬‡ï¸ é‚è¼¯æ˜ å°„ â¬‡ï¸</div>

                <div>
                    <h3 class="text-sm font-bold text-blue-400 mb-2">ğŸ–¥ï¸ éŠæˆ²ç•«é¢æ¨¡æ“¬ (Live)</h3>
                    <p class="text-xs text-gray-500 mb-4">å…±ç”¨æ¬„ä½å¯¦éš›ç•«é¢ã€‚</p>
                    <div id="live-view"></div>
                    <div class="flex items-center justify-center gap-2 mt-2">
                        <span class="text-xs text-green-500 font-bold px-2 py-1 bg-green-900/30 rounded" id="sim-status">ç‹€æ…‹ï¼šé—œé–‰ (å·²é‚„åŸ)</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="panel">
                <div class="panel-title">å·¨é›†ç”Ÿæˆçµæœ</div>
                
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-green-400 font-bold !mb-0">ğŸŸ¢ é–‹å•Ÿé¸å–®</label>
                        <span class="text-xs text-gray-500 bg-slate-900 px-2 py-1 rounded border border-slate-700">æ”¾åœ¨: <span id="loc-open">Checking...</span></span>
                    </div>
                    <textarea id="code-open" class="macro" readonly></textarea>
                    <button class="btn-copy" onclick="copyTo('code-open')">è¤‡è£½é–‹å•Ÿå·¨é›†</button>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-red-400 font-bold !mb-0">ğŸ”´ é—œé–‰é¸å–®</label>
                        <span class="text-xs text-gray-500 bg-slate-900 px-2 py-1 rounded border border-slate-700">æ”¾åœ¨: <span id="loc-close">Checking...</span></span>
                    </div>
                    <textarea id="code-close" class="macro" readonly></textarea>
                    <button class="btn-copy" onclick="copyTo('code-close')">è¤‡è£½é—œé–‰å·¨é›†</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Data & State
        let sharedBars = [4, 5]; 
        let isMenuOpen = false;

        // å…¨è·æ¥­åˆ—è¡¨å­—ä¸² (åŒ…å«å®Œæ•´ä¸­æ–‡)
        const jobOptionsHtml = `
            <optgroup label="å¸¸ç”¨/ç”Ÿç”¢æ¡é›†">
                <option value="LTW">è£½é©åŒ  (LTW)</option>
                <option value="CRP">åˆ»æœ¨åŒ  (CRP)</option>
                <option value="BSM">é›éµåŒ  (BSM)</option>
                <option value="ARM">é‘„ç”²åŒ  (ARM)</option>
                <option value="GSM">é›•é‡‘åŒ  (GSM)</option>
                <option value="WVR">è£è¡£åŒ  (WVR)</option>
                <option value="ALC">éŠé‡‘è¡“å£« (ALC)</option>
                <option value="CUL">çƒ¹èª¿å¸« (CUL)</option>
                <option value="MIN">æ¡ç¤¦å·¥ (MIN)</option>
                <option value="BTN">åœ’è—å·¥ (BTN)</option>
                <option value="FSH">æ•é­šäºº (FSH)</option>
            </optgroup>
            <optgroup label="é˜²è­·è·æ¥­ (Tank)">
                <option value="PLD">é¨å£« (PLD)</option>
                <option value="WAR">æˆ°å£« (WAR)</option>
                <option value="DRK">æš—é»‘é¨å£« (DRK)</option>
                <option value="GNB">çµ•æ§æˆ°å£« (GNB)</option>
            </optgroup>
            <optgroup label="æ²»ç™‚è·æ¥­ (Healer)">
                <option value="WHM">ç™½é­”æ³•å¸« (WHM)</option>
                <option value="SCH">å­¸è€… (SCH)</option>
                <option value="AST">å æ˜Ÿè¡“å£« (AST)</option>
                <option value="SGE">è³¢è€… (SGE)</option>
            </optgroup>
            <optgroup label="è¿‘æˆ°æ”»æ“Š (Melee)">
                <option value="MNK">æ­¦åƒ§ (MNK)</option>
                <option value="DRG">é¾é¨å£« (DRG)</option>
                <option value="NIN">å¿è€… (NIN)</option>
                <option value="SAM">æ­¦å£« (SAM)</option>
                <option value="RPR">éŒåˆ€æ‰‹ (RPR)</option>
                <option value="VPR">è›‡æ­¦ (VPR)</option>
            </optgroup>
            <optgroup label="é ç¨‹/æ³•ç³» (Ranged/Magic)">
                <option value="BRD">åŸéŠè©©äºº (BRD)</option>
                <option value="MCH">æ©Ÿå·¥å£« (MCH)</option>
                <option value="DNC">èˆè€… (DNC)</option>
                <option value="BLM">é»‘é­”æ³•å¸« (BLM)</option>
                <option value="SMN">å¬å–šå¸« (SMN)</option>
                <option value="RDM">èµ¤é­”æ³•å¸« (RDM)</option>
                <option value="PCT">ç¹ªéˆæ³•å¸« (PCT)</option>
                <option value="BLU">é’é­”æ³•å¸« (BLU)</option>
            </optgroup>
            <optgroup label="åŸºç¤è·æ¥­ (Base)">
                <option value="GLA">åŠè¡“å¸« (GLA)</option> <option value="MRD">æ–§è¡“å¸« (MRD)</option> 
                <option value="ARC">å¼“ç®­æ‰‹ (ARC)</option> <option value="LNC">æ§è¡“å¸« (LNC)</option>
                <option value="ROG">é›™åŠå¸« (ROG)</option> <option value="PGL">æ ¼é¬¥å®¶ (PGL)</option>
                <option value="THM">å’’è¡“å¸« (THM)</option> <option value="ACN">ç§˜è¡“å¸« (ACN)</option>
                <option value="CNJ">å¹»è¡“å¸« (CNJ)</option>
            </optgroup>
        `;

        function init() {
            renderCheckboxes();
            updateHubOptions();
            generateRows(); 
            updateAll();
        }

        // 1. Checkboxes
        function renderCheckboxes() {
            const container = document.getElementById('shared-cb-container');
            container.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const div = document.createElement('div');
                div.className = `cb-item ${sharedBars.includes(i) ? 'active' : ''}`;
                div.innerText = `å¿«é€Ÿéµ ${i}`;
                div.onclick = () => toggleShared(i);
                container.appendChild(div);
            }
        }

        function toggleShared(num) {
            if (sharedBars.includes(num)) {
                sharedBars = sharedBars.filter(n => n !== num);
            } else {
                sharedBars.push(num);
            }
            sharedBars.sort((a,b) => a-b);
            renderCheckboxes();
            updateHubOptions(); 
            generateRows(); 
            updateAll();
        }

        // 2. Hub Logic
        function updateHubOptions() {
            const allBars = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            const availableSources = allBars.filter(b => !sharedBars.includes(b));
            
            const hubSelect = document.getElementById('hubSource');
            const currentHub = parseInt(hubSelect.value);
            
            hubSelect.innerHTML = '';
            availableSources.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                opt.text = `å¿«é€Ÿéµ ${b}`;
                hubSelect.appendChild(opt);
            });

            if(availableSources.includes(currentHub)) {
                hubSelect.value = currentHub;
            } else if(availableSources.length > 0) {
                hubSelect.value = availableSources[0];
            }
        }

        function onHubChange() {
            updateRowOptions(); 
            updateAll();
        }

        // 3. Dynamic Rows
        function generateRows() {
            const container = document.getElementById('dynamic-rows-container');
            const currentValues = {}; 
            container.querySelectorAll('.spoke-card').forEach(card => {
                const target = card.dataset.target;
                currentValues[target] = {
                    source: card.querySelector('.row-source').value,
                    resetJob: card.querySelector('.row-reset-job').value,
                    resetBar: card.querySelector('.row-reset-bar').value
                };
            });

            container.innerHTML = '';

            if(sharedBars.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500 text-center py-4">è«‹åœ¨ä¸Šæ–¹å‹¾é¸è‡³å°‘ä¸€å€‹å…±ç”¨æ¬„ä½</div>';
                return;
            }

            sharedBars.forEach((target, idx) => {
                const card = document.createElement('div');
                card.className = 'spoke-card';
                card.dataset.target = target;
                card.dataset.idx = idx; 

                let defResetJob = (idx === 0) ? document.getElementById('storageJob').value : 'CRP';
                let defResetBar = (idx === 0) ? (document.getElementById('hubSource').value || 3) : 1;

                if(currentValues[target]) {
                    defResetJob = currentValues[target].resetJob;
                    defResetBar = currentValues[target].resetBar;
                }

                let barOpts = '';
                for(let b=1; b<=10; b++) {
                    barOpts += `<option value="${b}" ${parseInt(b) === parseInt(defResetBar) ? 'selected' : ''}>å¿«é€Ÿéµ ${b}</option>`;
                }

                let hintHtml = '';
                if(idx === 0) {
                    hintHtml = `
                        <div class="mt-2 p-2 bg-green-900/30 border border-green-800 rounded text-xs text-green-300">
                            ğŸ’¡ <strong>å»ºè­°ï¼š</strong>å°‡æ­¤é‚„åŸç‚º <strong>[${document.getElementById('storageJob').value}]</strong> çš„ <strong>[å¿«é€Ÿéµ ${document.getElementById('hubSource').value || '?'}]</strong>ã€‚<br>
                            é€™æ¨£é—œé–‰å¾Œï¼ŒæŒ‰éˆ•æ‰æœƒè®Šå›ã€Œé–‹å•Ÿé¸å–®ã€ã€‚
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="spoke-label">å°æ‡‰å…±ç”¨æ¬„ä½ (Share ${target})</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        <div>
                            <label class="text-blue-300 font-bold">é–‹å•Ÿæ™‚é¡¯ç¤ºå…§å®¹</label>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500 whitespace-nowrap">ä¾†è‡ªå€‰åº«</span>
                                <select class="row-source" onchange="updateAll()"></select>
                            </div>
                        </div>
                        <div>
                            <label class="text-red-300 font-bold">é—œé–‰æ™‚é‚„åŸæˆä½ è¦çš„æ¬„ä½</label>
                            <div class="flex gap-2">
                                <select class="row-reset-job w-1/3" onchange="updateAll()">
                                    ${jobOptionsHtml}
                                </select>
                                <select class="row-reset-bar flex-1" onchange="updateAll()">
                                    ${barOpts}
                                </select>
                            </div>
                            ${hintHtml}
                        </div>
                    </div>
                `;
                
                card.querySelector('.row-reset-job').value = defResetJob;
                container.appendChild(card);
            });

            updateRowOptions(currentValues);
        }

        function updateRowOptions(savedValues = {}) {
            const hubBar = parseInt(document.getElementById('hubSource').value);
            const allBars = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            const availableSources = allBars.filter(b => !sharedBars.includes(b) && b !== hubBar);

            const cards = document.querySelectorAll('.spoke-card');
            let sourceIndexCounter = 0;

            cards.forEach(card => {
                const select = card.querySelector('.row-source');
                const target = card.dataset.target;
                const savedVal = savedValues[target] ? parseInt(savedValues[target].source) : null;

                select.innerHTML = '';
                availableSources.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.text = `å¿«é€Ÿéµ ${b}`;
                    select.appendChild(opt);
                });

                if(savedVal && availableSources.includes(savedVal)) {
                    select.value = savedVal;
                } else if (availableSources.length > 0) {
                    select.value = availableSources[sourceIndexCounter % availableSources.length];
                }
                sourceIndexCounter++;
            });
        }

        // 4. Update
        function updateAll() {
            updateVisuals();
            updateCode(); // é€™ä¹‹å‰ä¸æœƒå†å´©æ½°äº†
        }

        function getRowsData() {
            const rows = [];
            document.querySelectorAll('.spoke-card').forEach(card => {
                rows.push({
                    target: parseInt(card.dataset.target),
                    source: parseInt(card.querySelector('.row-source').value),
                    resetJob: card.querySelector('.row-reset-job').value,
                    resetBar: parseInt(card.querySelector('.row-reset-bar').value),
                    isFirst: (parseInt(card.dataset.idx) === 0) 
                });
            });
            return rows;
        }

        function renderGrid(type, slotNum = null, isFirstRow = true) {
            let html = `<div class="slots-grid">`;
            for(let i=1; i<=12; i++) {
                let classes = "slot";
                let content = "";
                let onClick = "";

                if (type === 'hub') {
                    if (i === slotNum) { classes += " trigger"; content = "OPEN"; }
                    else classes += " occupied";
                } 
                else if (type === 'source') {
                    if (isFirstRow && i === slotNum) { 
                        classes += " close"; content = "CLOSE"; 
                    } else { 
                        classes += " content"; 
                    }
                } 
                else if (type === 'live-open') {
                    onClick = `onclick="toggleSim()"`;
                    if (isFirstRow && i === slotNum) { 
                        classes += " close"; content = "CLOSE"; 
                    } else { 
                        classes += " content"; 
                    }
                }
                else if (type === 'live-closed') {
                    onClick = `onclick="toggleSim()"`;
                    if(isFirstRow && i === slotNum) { 
                         classes += " trigger"; content = "OPEN";
                    } else {
                         classes += " reset";
                    }
                }

                html += `<div class="${classes}" ${onClick}><span style="position:absolute; top:1px; left:2px; font-size:8px; opacity:0.5;">${i}</span>${content}</div>`;
            }
            html += `</div>`;
            return html;
        }

        function updateVisuals() {
            const storageJob = document.getElementById('storageJob').value;
            const hubBar = parseInt(document.getElementById('hubSource').value);
            const triggerSlot = parseInt(document.getElementById('triggerSlot').value);
            const rows = getRowsData();

            // Warehouse
            const whContainer = document.getElementById('warehouse-view');
            let whHtml = '';
            
            whHtml += `<div class="bar-container">
                        <div class="bar-label"><span>${storageJob} ${hubBar} (Hub)</span><span>ä¸­æ¨</span></div>
                        ${renderGrid('hub', triggerSlot)}
                       </div>`;

            rows.forEach(r => {
                const labelType = r.isFirst ? "å…§å®¹+é—œé–‰éˆ•" : "åƒ…å…§å®¹";
                whHtml += `<div class="bar-container">
                            <div class="bar-label"><span>${storageJob} ${r.source} (ç”¨æ–¼ Share ${r.target})</span><span>${labelType}</span></div>
                            ${renderGrid('source', triggerSlot, r.isFirst)}
                           </div>`;
            });
            whContainer.innerHTML = whHtml;

            // Live
            const liveContainer = document.getElementById('live-view');
            let liveHtml = '';

            rows.forEach(r => {
                let gridHtml = '';
                let label = '';
                
                if (isMenuOpen) {
                    label = `<span class="text-blue-300">Share ${r.target} (å±•é–‹: ${storageJob} ${r.source})</span>`;
                    gridHtml = renderGrid('live-open', triggerSlot, r.isFirst);
                } else {
                    label = `<span class="text-red-300">Share ${r.target} (é‚„åŸ: ${r.resetJob} ${r.resetBar})</span>`;
                    const resetsToHub = (r.resetJob === storageJob && r.resetBar === hubBar);
                    
                    gridHtml = `<div class="slots-grid">`;
                    for(let i=1; i<=12; i++) {
                        let cls = "slot";
                        let txt = "";
                        if(resetsToHub && i === triggerSlot) {
                            cls += " trigger"; txt = "OPEN";
                        } else {
                            cls += " reset";
                        }
                        gridHtml += `<div class="${cls}" onclick="toggleSim()">${txt}</div>`;
                    }
                    gridHtml += `</div>`;
                }
                liveHtml += `<div class="bar-container"><div class="bar-label">${label}</div>${gridHtml}</div>`;
            });

            liveContainer.innerHTML = liveHtml;
            document.getElementById('sim-status').innerText = isMenuOpen ? "ç‹€æ…‹ï¼šé–‹å•Ÿ (å±•é–‹ä¸­)" : "ç‹€æ…‹ï¼šé—œé–‰ (å·²é‚„åŸ)";
            document.getElementById('sim-status').className = isMenuOpen ? "text-xs text-blue-500 font-bold px-2 py-1 bg-blue-900/30 rounded" : "text-xs text-green-500 font-bold px-2 py-1 bg-green-900/30 rounded";

            // Labels
            // ä¿®æ­£ï¼šåˆªé™¤å°è‡´éŒ¯èª¤çš„ lbl-job-storage åƒè€ƒ
            const firstRow = rows[0];
            if(firstRow) {
                document.getElementById('loc-open').innerText = `${storageJob} ${hubBar} (æ ¼${triggerSlot})`;
                document.getElementById('loc-close').innerText = `${storageJob} ${firstRow.source} (æ ¼${triggerSlot})`;
            }
        }

        function toggleSim() {
            isMenuOpen = !isMenuOpen;
            updateVisuals();
        }

        // 5. Code
        function updateCode() {
            const storageJob = document.getElementById('storageJob').value;
            const rows = getRowsData();
            const autoClose = document.getElementById('autoClose').checked;
            const waitSec = document.getElementById('waitSec').value;

            // Open Macro
            let open = `/micon "Main Command"\n`;
            rows.forEach(r => {
                open += `/hotbar copy ${storageJob} ${r.source} share ${r.target}\n`;
            });

            if (autoClose) {
                open += `/wait ${waitSec}\n`;
                // è‡ªå‹•é—œé–‰çš„é‚è¼¯ï¼šåŸ·è¡Œä¸€æ¬¡é‚„åŸæ“ä½œ
                rows.forEach(r => {
                    open += `/hotbar copy ${r.resetJob} ${r.resetBar} share ${r.target}\n`;
                });
            }

            // Close Macro
            let close = `/micon "Return"\n`;
            rows.forEach(r => {
                close += `/hotbar copy ${r.resetJob} ${r.resetBar} share ${r.target}\n`;
            });

            // Set Values
            document.getElementById('code-open').value = open;
            document.getElementById('code-close').value = close;
        }

        function copyTo(id) {
            const el = document.getElementById(id);
            if(!el) return;
            el.select();
            navigator.clipboard.writeText(el.value).then(() => {
                alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
            }).catch(err => {
                console.error("è¤‡è£½å¤±æ•—", err);
                alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚");
            });
        }

        // Init
        init();
    </script>
</body>
</html>
